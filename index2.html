<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (S4 & S5)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #0056b3;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        .section-header {
            background-color: #eaf6ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff0d9;
            color: #ff8c00;
            font-weight: bold;
            min-height: 40px;
            display: flex;
            align-items: center;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            opacity: 0.9;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #answerHBtn, #answerABtn {
            background-color: #28a745;
            color: white;
        }
        #nextSection5Btn {
            background-color: #007bff;
            color: white;
        }
        #startABtn {
            background-color: #6c757d;
            color: white;
        }
        #finalSaveBtn {
            background-color: #dc3545;
            color: white;
        }
        .audio-controls {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á */
        #section3, #section4, #section5 {
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö: ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4 ‡πÅ‡∏•‡∏∞ 5</h1>
    <p>üí° **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° **'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°'** ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î **'‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</p>
    
    <button id="startAppBtn" style="background-color: #007bff; color: white;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4)</button>

    <div id="section3Div" style="display: none;">
        <h2 class="section-header">‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</h2>
        <p>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4...</p>
        <button id="nextSection4Btn" style="background-color: #ffc107; color: black;" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4</button>
    </div>

    <hr>
    
    <div id="section4Div">
        <h2 class="section-header">‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (Health Check)</h2>
        
        <p><strong>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> <span id="hQName">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1/5: [‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞]</span></p>
        
        <button id="answerHBtn" data-section="section4">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
        <button id="stopHBtn" style="background-color: #ff6600; color: white;" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        
        <div id="hStatus" class="status">‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 1: [‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°]</div>
        
        <div class="audio-controls">
            <p><strong>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô:</strong></p>
            <audio id="healthAudio" controls></audio>
        </div>
        
        <button id="nextSection5Btn" style="margin-top: 20px;" disabled>‚ñ∂Ô∏è ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4: ‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5</button>
    </div>

    <hr>

    <div id="section5Div">
        <h2 class="section-header">‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà <span id="aRound">0</span>/<span id="maxASpan">7</span>)</h2>
        
        <button id="startABtn" data-section="section5">üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        <button id="answerABtn" data-section="section5" disabled>üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        <button id="stopABtn" style="background-color: #ff6600; color: white;" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

        <div id="aStatus" class="status">‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5 (7 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)</div>
        
        <div class="audio-controls">
            <p><strong>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô:</strong></p>
            <audio id="agreementAudio" controls></audio>
        </div>
        
        <button id="finalSaveBtn" style="margin-top: 20px; background-color: #dc3545;" disabled>üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
    </div>

</div>

<script type="module">
    
    // ====================================================================
    // --- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: S4 & S5 LOGIC MODULE (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Bug ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏£‡∏Å‡∏∞ S5 ‡πÅ‡∏•‡πâ‡∏ß) ---
    // ====================================================================

    // --- S4/S5 Module State Variables (PRIVATE) ---
    let currentHIndex = 0; 
    let isFollowUpMode = false;
    let followUpStep = 0; 
    let selectedDisease = null;
    let aRound = 0; // Index for current registration step (0 to 6)
    let maxH = 5; 
    let maxA = 7; 

    // --- S4/S5 Data Structures (‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) ---

    // Section 5 Data (REGISTRATION)
    // NOTE: registrationStepNames ‡∏Ñ‡∏∑‡∏≠ PROMPT ‡∏ó‡∏µ‡πà‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏π‡∏î/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    const registrationStepNames = [
        "1. ‡∏Ç‡∏≠‡∏™‡∏∞‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", 
        "2. ‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô", 
        "3. ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠", 
        "4. ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà", 
        "5. ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞", 
        "6. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á PDPA ‡πÅ‡∏•‡∏∞‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢", 
        "7. ‡∏≠‡πà‡∏≤‡∏ô E-Consent/E-Legal" 
    ];
    // NOTE: registrationScriptFiles ‡∏Ñ‡∏∑‡∏≠ ANSWER ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏ï‡πà‡∏≠ PROMPT ‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    const registrationScriptFiles = [
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q2/health6_P1_P1Q2_1762518493530.webm", // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: ‡∏™‡∏∞‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q3/health6_P1_P1Q3_1762518514882.webm", // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q4/health6_P1_P1Q4_1762518543370.webm", // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q5/health6_P1_P1Q5_1762518584458.webm", // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q6/health6_P1_P1Q6_1762518625330.webm", // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q7/health6_P1_P1Q7_1762518654346.webm", // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: PDPA
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q8/health6_P1_P1Q8_1762518676715.webm"  // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô E-Consent
    ];

    // Section 4 Data (HEALTH CHECK) - (S4 logic is unchanged)
    const H_QUESTION_NAMES = [
        "1. ‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏´‡∏±‡∏ß‡πÉ‡∏à, ‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á ‡∏Ø‡∏•‡∏Ø)", "2. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î/‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏±‡∏ß", "3. ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ",
        "4. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏≠‡∏∑‡πà‡∏ô", "5. ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î"
    ];
    const F_QUESTION_NAMES = {
        1: "F1: ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà", 
        2: "F2: ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£", 
        3: "F3: ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå", 
        4: "F4: ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà", 
        5: "F5: ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£" 
    };
    const NO_ANSWER_URL = "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q3/health5_P1_P1Q3_1762340907852.webm"; 
    const CHANCE_OF_YES = 0.35; 
    const MAX_FOLLOW_UP_STEPS = 5; 
    const DISEASE_POOL = [
        // (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞ URL ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡∏∞‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°)
        { 
            name: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á", 
            yesTriggerUrl: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q1_9f79f14f-6b49-4215-a8d2-6c290175845c.webm", 
            followUp: {
                1: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q2_7a0089f6-fad2-4264-84dc-e4a9fd76bf9d.webm", 
                2: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q3_5b21f4b1-a1f1-4f87-823c-32bcee3a1e35.webm", 
                3: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q4_1ca0ed14-8f32-4067-a270-a369a475f852.webm", 
                4: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q5_172736d1-1e8f-4149-914a-66eafbc64efd.webm", 
                5: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q6_ff573737-1694-49ce-bf5a-d2853dd0b2ae.webm" 
            }
        },
        // ... (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏≠‡∏∑‡πà‡∏ô‡πÜ) ...
    ];

    // --- S4 Logic Functions (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ---
    // ... (initializeState, updateHealthQuestionUI, initSection4, startFollowUpQuestion, playDynamicHealthQuestion) ...

    function initializeState(params) {
        currentHIndex = 0; isFollowUpMode = false; followUpStep = 0; selectedDisease = null;
        aRound = 0; maxH = params.maxH; maxA = params.maxA;
    }
    function updateHealthQuestionUI() {
        const hQName = document.getElementById("hQName");
        const answerHBtn = document.getElementById("answerHBtn");
        if (isFollowUpMode) {
            hQName.textContent = `‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ: ${selectedDisease.name} (${F_QUESTION_NAMES[followUpStep]})`;
            answerHBtn.textContent = 'üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ';
        } else if (currentHIndex < maxH) {
             hQName.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentHIndex + 1}/${maxH}: ${H_QUESTION_NAMES[currentHIndex]}`;
             answerHBtn.textContent = 'üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û';
        } else {
             hQName.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô`;
        }
    }
    function initSection4(DOM) {
        DOM.section3Div.style.display = 'none'; DOM.section4Div.style.display = 'block';
        DOM.nextSection5Btn.disabled = true; DOM.answerHBtn.disabled = true;
        currentHIndex = 0; isFollowUpMode = false; followUpStep = 0; selectedDisease = null;
        updateHealthQuestionUI(); 
        DOM.answerHBtn.disabled = false; 
        DOM.hStatusElement.textContent = `‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 1: ${H_QUESTION_NAMES[0]}`; 
        alert("‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 ‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (5 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)");
    }
    function startFollowUpQuestion() {
        const healthAudio = document.getElementById("healthAudio");
        const hStatusElement = document.getElementById("hStatus");
        const answerHBtn = document.getElementById("answerHBtn");
        if (!selectedDisease || followUpStep > MAX_FOLLOW_UP_STEPS) return; 
        const currentQName = F_QUESTION_NAMES[followUpStep];
        updateHealthQuestionUI(); 
        answerHBtn.disabled = true;
        hStatusElement.textContent = `‚è≥ (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...`; 
        setTimeout(() => {
            healthAudio.pause();
            hStatusElement.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ: ${currentQName} (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏î)`; 
            answerHBtn.disabled = false;
        }, 700); 
    }
    function playDynamicHealthQuestion() {
        const healthAudio = document.getElementById("healthAudio");
        const hStatusElement = document.getElementById("hStatus");
        const answerHBtn = document.getElementById("answerHBtn");
        const nextSection5Btn = document.getElementById("nextSection5Btn");
        answerHBtn.disabled = true;
        if (isFollowUpMode) {
            // ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ: ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à -> ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            const customerAnswerUrl = selectedDisease.followUp[followUpStep];
            healthAudio.src = customerAnswerUrl; healthAudio.load();
            hStatusElement.textContent = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ${F_QUESTION_NAMES[followUpStep]} (‡πÇ‡∏£‡∏Ñ: ${selectedDisease.name})...`;
            healthAudio.onloadeddata = () => { healthAudio.play(); hStatusElement.textContent = `üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...`; };
            healthAudio.onended = () => {
                followUpStep++;
                if (followUpStep > MAX_FOLLOW_UP_STEPS) {
                    isFollowUpMode = false; selectedDisease = null; followUpStep = 0; currentHIndex++; 
                    if (currentHIndex < maxH) {
                        updateHealthQuestionUI(); hStatusElement.textContent = `‚úÖ ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${currentHIndex + 1}/${maxH}`;
                        answerHBtn.disabled = false; 
                    } else {
                        updateHealthQuestionUI(); nextSection5Btn.disabled = false;
                        hStatusElement.textContent = `üéâ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏ö ${maxH} ‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5`;
                    }
                } else {
                    startFollowUpQuestion();
                }
            };
        } else {
            // ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô: ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à -> ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            if (currentHIndex >= maxH) {
                nextSection5Btn.disabled = false; hStatusElement.textContent = `üéâ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏ö ${maxH} ‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5`;
                return;
            }
            const isYes = Math.random() < CHANCE_OF_YES;
            if (isYes) {
                const randomIndex = Math.floor(Math.random() * DISEASE_POOL.length);
                selectedDisease = DISEASE_POOL[randomIndex]; isFollowUpMode = true; followUpStep = 1; 
                healthAudio.src = selectedDisease.yesTriggerUrl; healthAudio.load();
                hStatusElement.textContent = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡πÉ‡∏ä‡πà" (‡πÇ‡∏£‡∏Ñ: ${selectedDisease.name})...`;
                healthAudio.onloadeddata = () => { healthAudio.play(); hStatusElement.textContent = `üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡πÉ‡∏ä‡πà" (‡πÇ‡∏£‡∏Ñ: ${selectedDisease.name})...`; };
                healthAudio.onended = () => { startFollowUpQuestion(); };
            } else {
                healthAudio.src = NO_ANSWER_URL; healthAudio.load();
                hStatusElement.textContent = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö"...`;
                healthAudio.onloadeddata = () => { healthAudio.play(); hStatusElement.textContent = `üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö"...`; };
                healthAudio.onended = () => {
                    currentHIndex++; 
                    if (currentHIndex < maxH) {
                        updateHealthQuestionUI(); hStatusElement.textContent = `‚úÖ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠ '‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${currentHIndex + 1}/${maxH}`;
                        answerHBtn.disabled = false; 
                    } else {
                        updateHealthQuestionUI(); nextSection5Btn.disabled = false;
                        hStatusElement.textContent = `üéâ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏ö ${maxH} ‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5`;
                    }
                };
            }
        }
    }


    // ====================================================================
    // --- SECTION 5 LOGIC (‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÅ‡∏•‡πâ‡∏ß) ---
    // ====================================================================

    /**
     * 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Section 5
     */
    function initSection5(DOM) {
        DOM.section4Div.style.display = 'none';
        DOM.section5Div.style.display = 'block';

        DOM.nextSection5Btn.disabled = true;
        
        DOM.startABtn.style.display = 'block';
        DOM.startABtn.disabled = false;
        DOM.answerABtn.disabled = true;
        DOM.stopABtn.disabled = true;
        DOM.finalSaveBtn.disabled = true;
        
        aRound = 0; 
        
        DOM.aStatusElement.textContent = `‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1/${maxA} (7 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)`; 
        document.getElementById("maxASpan").textContent = maxA;
        alert("‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4 ‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (7 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)");
    }

    /**
     * 5. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° UI ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà roundIndex + 1 (A1 ‡∏ñ‡∏∂‡∏á A7)
     * @param {number} roundIndex - Index ‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö (0 ‡∏ñ‡∏∂‡∏á maxA - 1)
     */
    function prepareAgentRecording(roundIndex) {
        const aRoundSpan = document.getElementById("aRound");
        const aStatusElement = document.getElementById("aStatus");
        const answerABtn = document.getElementById("answerABtn");
        const startABtn = document.getElementById("startABtn");
        
        const currentStepName = registrationStepNames[roundIndex];
        
        aRoundSpan.textContent = roundIndex + 1;
        
        aStatusElement.textContent = `üé§ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${roundIndex + 1}/${maxA}: ${currentStepName}`; 
        answerABtn.disabled = false;
        
        if (roundIndex === 0) {
            startABtn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        }
    }

    /**
     * 6. ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (aRound)
     * (‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏î‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)
     */
    function playCustomerRegistrationResponse() {
        const agreementAudio = document.getElementById("agreementAudio");
        const aStatusElement = document.getElementById("aStatus");
        const finalSaveBtn = document.getElementById("finalSaveBtn");
        const answerABtn = document.getElementById("answerABtn");
        
        const roundIndex = aRound; // ‡πÉ‡∏ä‡πâ Index ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (aRound)
        
        if (roundIndex >= maxA) return; // ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î

        const selectedFile = registrationScriptFiles[roundIndex]; 
        
        agreementAudio.src = selectedFile;
        agreementAudio.load();

        aStatusElement.textContent = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${roundIndex + 1}/${maxA}...`; 
        
        // Disable answer button until customer response ends
        answerABtn.disabled = true;

        agreementAudio.onloadeddata = () => {
            agreementAudio.play();
            aStatusElement.textContent = `üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${registrationStepNames[roundIndex]}...`; 
        };
        
        agreementAudio.onended = () => {
            aRound++; // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ Index ‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ

            if (aRound < maxA) {
                // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                prepareAgentRecording(aRound); 
            } else {
                // ‡∏à‡∏ö S5
                aStatusElement.textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î'"; 
                finalSaveBtn.disabled = false;
                answerABtn.disabled = true;
            }
        };
    }


    // ====================================================================
    // --- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: Main Application Setup & Simulation Functions ---
    // ====================================================================

    // DOM References
    const DOM = {
        section3Div: document.getElementById('section3Div'), section4Div: document.getElementById('section4Div'), section5Div: document.getElementById('section5Div'),
        hQName: document.getElementById('hQName'), hStatusElement: document.getElementById('hStatus'), answerHBtn: document.getElementById('answerHBtn'), stopHBtn: document.getElementById('stopHBtn'), healthAudio: document.getElementById('healthAudio'), nextSection5Btn: document.getElementById('nextSection5Btn'),
        aStatusElement: document.getElementById('aStatus'), startABtn: document.getElementById('startABtn'), answerABtn: document.getElementById('answerABtn'), stopABtn: document.getElementById('stopABtn'), agreementAudio: document.getElementById('agreementAudio'), finalSaveBtn: document.getElementById('finalSaveBtn'), maxA: 7 
    };

    let isRecording = false; 

    function startRecording(sectionId) {
        if (isRecording) return;
        isRecording = true;
        
        if (sectionId === 'section4') {
            DOM.answerHBtn.disabled = true;
            DOM.stopHBtn.disabled = false;
            DOM.hStatusElement.textContent = 'üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...';
            DOM.healthAudio.pause(); 
        } else if (sectionId === 'section5') {
            DOM.answerABtn.disabled = true;
            DOM.stopABtn.disabled = false;
            DOM.aStatusElement.textContent = 'üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...';
            DOM.agreementAudio.pause(); 
        }
    }

    function stopRecording(sectionId) {
        if (!isRecording) return;
        isRecording = false;
        
        if (sectionId === 'section4') {
            DOM.stopHBtn.disabled = true;
        } else if (sectionId === 'section5') {
            DOM.stopABtn.disabled = true;
        }

        onRecordingStopped(sectionId);
    }

    function onRecordingStopped(sectionId) {
        if (sectionId === 'section4') {
            playDynamicHealthQuestion(); // S4 Logic: ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        } else if (sectionId === 'section5') {
            playCustomerRegistrationResponse(); // S5 Logic: ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏û‡∏π‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à -> ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        }
    }

    function setupListeners() {
        document.getElementById('startAppBtn').addEventListener('click', () => {
            document.getElementById('startAppBtn').style.display = 'none';
            initSection4(DOM);
        });

        // S4 Listeners (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)
        DOM.answerHBtn.addEventListener('click', (e) => startRecording(e.target.dataset.section));
        DOM.stopHBtn.addEventListener('click', (e) => stopRecording('section4'));
        DOM.nextSection5Btn.addEventListener('click', () => initSection5(DOM));

        // S5 Listeners (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
        DOM.startABtn.addEventListener('click', () => {
            aRound = 0; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà index 0
            prepareAgentRecording(aRound); // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô A1
        });
        DOM.answerABtn.addEventListener('click', (e) => startRecording(e.target.dataset.section));
        DOM.stopABtn.addEventListener('click', (e) => stopRecording('section5'));

        DOM.finalSaveBtn.addEventListener('click', () => {
            alert('‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå');
        });
    }

    function initApp() {
        initializeState({ maxH: 5, maxA: 7 });
        DOM.section4Div.style.display = 'none';
        DOM.section5Div.style.display = 'none';
        setupListeners();
    }

    document.addEventListener('DOMContentLoaded', initApp);

</script>

</body>
</html>
