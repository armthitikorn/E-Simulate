<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';
// --- 1. Supabase Config & Global State ---
// (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°...)

        // State Variables
        let masterAudioChunks = [];
        let mediaRecorder = null;
        let currentUserId = null; 
        const USER_ID_KEY = 'roleplay_user_id';
// Round Counters (Dynamic based on difficulty)
        let turn = 0;
        let qRound = 0;
        let cRound = 0;
        let currentHIndex = 0; 
        let isFollowUpMode = false;
        let followUpStep = 0;
        let selectedDisease = null; // **STATE ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ**
        let aRound = 0; 

        // Global Max Rounds (Set dynamically by difficulty)
        let maxTurns;
        let maxQ;
        let maxC;
        let maxH = 1; // **FIXED: 1 Health Question**
        let maxFollowUp = 5; // **FIXED: 5 Follow-up questions**
        let maxA;
// (‡πÇ‡∏Ñ‡πâ‡∏î difficultyConfig ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°...)

// --- 2. Audio Files URL (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Section 1, 2, 3, 5 ‡πÅ‡∏•‡∏∞ S4-Logic) ---
// (‡πÇ‡∏Ñ‡πâ‡∏î S1, S2, S3, S5 ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°...)

// --- Section 4 Dynamic Health Check Data Structure (1 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å + 5 ‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥) ---
        
        // ** ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ "‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡πá‡∏ô" (YES) ‡πÄ‡∏™‡∏°‡∏≠ **
        const H_DISEASE_DATA = [
            {
                name: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á", 
                yesTriggerUrl: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q1_9f79f14f-6b49-4215-a8d2-6c290175845c.webm", 
                followUpReplies: [ // ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Q1-Q5
                    "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q2_7a0089f6-fad2-4264-84dc-e4a9fd76bf9d.webm", 
                    "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q3_5b21f4b1-a1f1-4f87-823c-32bcee3a1e35.webm", 
                    "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q4_1ca0ed14-8f32-4067-a270-a369a475f852.webm", 
                    "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q5_172736d1-1e8f-4149-914a-66eafbc64efd.webm", 
                    "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q6_ff573737-1694-49ce-bf5a-d2853dd0b2ae.webm" 
                ]
            },
            {
                name: "‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô", // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏ä‡∏∏‡∏î
                yesTriggerUrl: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part2/q1_diabetes.webm", 
                followUpReplies: [ 
                    "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part2/q2_diabetes.webm", 
                    "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part2/q3_diabetes.webm", 
                    "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part2/q4_diabetes.webm", 
                    "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part2/q5_diabetes.webm", 
                    "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part2/q6_diabetes.webm" 
                ]
            }
        ];
        
        // ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ 5 ‡∏Ç‡πâ‡∏≠
        const H_FOLLOW_UP_NAMES = [
            "1. ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà",
            "2. ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£",
            "3. ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå",
            "4. ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà",
            "5. ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£"
        ];
        
        const H_QUESTION_NAMES = ["‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å (Yes/No)"]; // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

// (‡πÇ‡∏Ñ‡πâ‡∏î Utility Functions ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°...)

        // --- Main Recording Logic (Updated to handle S4 state) ---
        window.toggleRecording = async function(type) {
            let statusElement, buttonElement, nextAutoAction, originalButtonText;
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° type 1-4)
            // SECTION 4 - Agent Records Health Question 1 (main)
            else if (type === 5) { statusElement = window.hStatusElement;
                buttonElement = window.answerHBtn; nextAutoAction = window.playDynamicHealthQuestion; originalButtonText = 'üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å';
            } 
            // SECTION 4 - Agent Records Follow-up Question (Q1-Q5)
            else if (type === 7) { statusElement = window.hStatusElement;
                buttonElement = window.followUpQBtn; nextAutoAction = window.playFollowUpQuestion; 
                originalButtonText = `üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Q${followUpStep + 1}`;
            } 
            // SECTION 5 
            else if (type === 6) { statusElement = window.aStatusElement;
                buttonElement = window.answerABtn; nextAutoAction = window.playSequentialRegistrationPrompt; originalButtonText = 'üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö';
            }
            
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡πà‡∏ß‡∏ô mediaRecorder)
            
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                try {
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡πà‡∏ß‡∏ô mediaRecorder.start())
                    
                    statusElement.textContent = "üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á... (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î)";
                    if (type === 3) buttonElement.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢";
                    else if (type === 4) buttonElement.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á";
                    else if (type === 5) buttonElement.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å"; // **UI ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á**
                    else if (type === 7) buttonElement.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"; // **UI ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á**
                    else if (type === 6) buttonElement.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö";
                    else buttonElement.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡πà‡∏ß‡∏ô disable next buttons)
                } catch (err) {
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡πà‡∏ß‡∏ô Error)
                }

            } else {
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡πà‡∏ß‡∏ô mediaRecorder.stop())
            }
        }
        
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° S1, S2)

        // --- Section 3 Functions (‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß) ---
        
        window.startNextCloseRoundAuto = function() {
            if (cRound < maxC) {
                window.s3StatusElement.textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°...";
                // **‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏à‡∏≤‡∏Å 1500ms ‡πÄ‡∏õ‡πá‡∏ô 500ms**
                setTimeout(window.playRandomObjectionAuto, 500); 
            } else {
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡πà‡∏ß‡∏ô end of S3)
            }
        }
        
        // --- Section 4 Dynamic Health Check Functions (‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ 5 ‡∏Ç‡πâ‡∏≠) ---
        
        function updateHealthQuestionUI() {
            if (isFollowUpMode) {
                window.hQName.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Q${followUpStep}/${maxFollowUp}: ${H_FOLLOW_UP_NAMES[followUpStep - 1]}`;
            } else {
                window.hQName.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentHIndex + 1}/${maxH}: ${H_QUESTION_NAMES[0]}`;
            }
        }

        window.initSection4 = function() {
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
            
            // Reset S4 State
            currentHIndex = 0;
            isFollowUpMode = false;
            followUpStep = 0;
            updateHealthQuestionUI(); 
            window.answerHBtn.disabled = false;
            window.followUpQBtn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            
            window.answerHBtn.textContent = 'üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å';
            window.hStatusElement.textContent = `‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å`;
            alert("‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 ‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (1 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏•‡∏∞ 5 ‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)");
        }
        
        // Function 1/3: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö "‡πÉ‡∏ä‡πà" ‡πÄ‡∏™‡∏°‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        window.playDynamicHealthQuestion = function() {
            window.answerHBtn.disabled = true;
            currentHIndex++; 
            isFollowUpMode = true; // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            
            // **‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö YES (‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡πá‡∏ô) ‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ**
            selectedDisease = randomSelect(H_DISEASE_DATA); 
            const customerReplyUrl = selectedDisease.yesTriggerUrl;

            window.healthAudio = getCachedAudioElement(customerReplyUrl, true);
            window.healthAudio.onloadeddata = () => {
                window.healthAudio.play();
                window.hStatusElement.textContent = `üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡πá‡∏ô${selectedDisease.name}...`;
            };
            // **‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ setTimeout)**
            window.healthAudio.onended = () => {
                window.hStatusElement.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Q1 (${H_FOLLOW_UP_NAMES[0]})`;
                window.answerHBtn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å
                window.followUpQBtn.style.display = 'block'; // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                window.followUpQBtn.textContent = 'üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Q1';
                window.followUpQBtn.disabled = false; 
                followUpStep = 0; // Reset ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏° Q1
            };
        }
        
        // Function 2/3: ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Q1-Q5 -> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö
        window.playFollowUpQuestion = function() {
            followUpStep++; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 1
            window.followUpQBtn.disabled = true;
            
            if (followUpStep > maxFollowUp) {
                // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                window.hStatusElement.textContent = `üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ${selectedDisease.name} ‡∏Ñ‡∏£‡∏ö 5 ‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4'`;
                window.followUpQBtn.style.display = 'none';
                window.nextSection5Btn.disabled = false;
                return;
            }
            
            updateHealthQuestionUI(); 
            const customerReplyUrl = selectedDisease.followUpReplies[followUpStep - 1]; 

            window.healthAudio = getCachedAudioElement(customerReplyUrl, true);
            window.healthAudio.onloadeddata = () => {
                window.healthAudio.play();
                window.hStatusElement.textContent = `üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Q${followUpStep}...`;
            };
            
            window.healthAudio.onended = () => {
                // **‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ setTimeout)**
                if (followUpStep < maxFollowUp) {
                    window.hStatusElement.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Q${followUpStep + 1} (${H_FOLLOW_UP_NAMES[followUpStep]})`;
                    window.followUpQBtn.textContent = `üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Q${followUpStep + 1}`;
                    window.followUpQBtn.disabled = false;
                } else {
                    // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                    window.hStatusElement.textContent = `üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ${selectedDisease.name} ‡∏Ñ‡∏£‡∏ö 5 ‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4'`;
                    window.followUpQBtn.style.display = 'none';
                    window.nextSection5Btn.disabled = false;
                }
            };
        }


        // --- Section 5 Functions (‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß) ---
        
        // ...
        
        window.playSequentialRegistrationPrompt = function() {
            // (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)

            window.agreementAudio.onended = () => {
                window.aStatusElement.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô: ${currentStepName}`;
                window.answerABtn.disabled = false;
                if (aRound === 1) window.startABtn.style.display = 'none';
                if (aRound < maxA) {
                    window.startABtn.textContent = `üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ${aRound + 1}/${maxA}`;
                }
            }; // **‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà setTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô**
        }
        
// (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞ Event Listeners)

        function initializeUserAndDOM() {
            // 1. Assign User ID (Ensures unique recording path)
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
// 2. DOM Element Assignments (All Sections)
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
// Section 4
            window.hQName = document.getElementById("hQName");
            window.hStatusElement = document.getElementById("hStatus");
            window.startHBtn = document.getElementById("startHBtn"); 
            window.answerHBtn = document.getElementById("answerHBtn");
            window.nextSection5Btn = document.getElementById("nextSection5Btn");
            window.healthAudio = document.getElementById("healthAudio");
            
            // **‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Q1-Q5**
            window.followUpQBtn = document.createElement('button');
            window.followUpQBtn.id = 'followUpQBtn';
            window.followUpQBtn.style.display = 'none';
            window.followUpQBtn.textContent = 'üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥';
            window.answerHBtn.parentNode.insertBefore(window.followUpQBtn, window.nextSection5Btn); // ‡πÅ‡∏ó‡∏£‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
            
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° S5)
// 3. Bind Event Listeners
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
            // S4 (Agent Record -> Customer Playback Logic)
            window.answerHBtn.addEventListener('click', () => window.toggleRecording(5));
            window.followUpQBtn.addEventListener('click', () => window.toggleRecording(7)); // **Event ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥**
            window.nextSection5Btn.addEventListener('click', window.initSection5);
// (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° S5 ‡πÅ‡∏•‡∏∞ startTest)
        }

        document.addEventListener('DOMContentLoaded', initializeUserAndDOM);
        
    </script>
