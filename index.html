<!DOCTYPE html>

<html lang="th">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Supabase ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) - ‡∏â‡∏ö‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á</title>
<style>
        /* 1. ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î (NEW) */
        body { 
            font-family: 'TH Sarabun New', sans-serif;
            padding: 20px; 
            text-align: center; 
        }
        
        h1 { /* 2. ‡∏õ‡∏£‡∏±‡∏ö h1 ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á */
            font-size: 28px;
            color: red; 
        }
        
        h2 { /* 2. ‡∏õ‡∏£‡∏±‡∏ö h2 (‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ä‡πà‡∏ß‡∏á) ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            margin-top: 25px;
            font-size: 22px; 
        }

        button { /* 1. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            margin: 10px 5px;
            padding: 12px 24px; 
            font-size: 18px; 
            cursor: pointer; 
            width: auto; 
            min-height: 48px;
        }
        button:disabled { opacity: 0.6; cursor: not-allowed;
        }
        
        /* 3. ‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        #certificate { 
            border: 5px solid #333;
            padding: 40px; 
            width: 90%; 
            max-width: 800px;
            margin: 40px auto; 
            text-align: center; 
            display: none;
        }
        
        #finalSaveBtn { background-color: #007bff;
            color: white; font-weight: bold; }
        #finalSaveBtn.done { background-color: #28a745;
        }
        
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            display: none; 
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            text-align: center;
            font-size: 20px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg);
            }
        }
        .progress {
            width: 80%;
            max-width: 400px;
            margin-top: 20px;
            height: 15px;
            background-color: #e9ecef;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #007bff;
            transition: width 0.6s ease;
        }
        .form-control {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            margin-top: 5px;
            text-align: center;
        }

        /* Difficulty Radio Styles */
        .difficulty-option {
            display: inline-block;
            margin: 10px;
            cursor: pointer;
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 5px;
            transition: all 0.2s;
        }
        .difficulty-option:hover {
            border-color: #007bff;
        }
        input[type="radio"]:checked + .difficulty-option {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            font-weight: bold;
        }
        input[type="radio"] {
            display: none;
        }
    </style>
</head>
<body>
<div id="loadingOverlay">
<div class="spinner-border text-light" role="status">
<span class="visually-hidden">Loading...</span>
</div>
<h5 class="mt-3" id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡∏ß‡∏°...</h5>
<div aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" class="progress" role="progressbar">
<div class="progress-bar" id="uploadProgressBar" style="width: 0%"></div>
</div>
</div>
<h1>E-Simulator Roleplay</h1>
<div style="max-width: 700px; margin: 0 auto; padding-bottom: 20px;">
<div id="registrationSection">
<h2 style="color: #333;">üìù ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
<div style="margin-bottom: 20px;">
<label for="inputUserName" style="font-weight: bold; display: block; margin-bottom: 10px;">
                    ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:
                </label>
<input class="form-control" id="inputUserName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required="" type="text"/>
</div>
<div style="margin-bottom: 30px;">
<div style="margin-bottom: 20px;"><label style="font-weight: bold;
display: block; margin-bottom: 10px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô:</label><a href="index.html"><button style="background-color: #007bff; color: white;">Health Insurance</button></a><a href="index1.html"><button style="background-color: #6c757d; color: white;">Endowment Insurance</button></a></div><label style="font-weight: bold; display: block;
margin-bottom: 10px;">
                    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:
                </label>
<div>
<input checked="" id="diffEasy" name="difficulty" type="radio" value="easy"/>
<label class="difficulty-option" for="diffEasy">‡∏á‡πà‡∏≤‡∏¢ (Easy)</label>
<input id="diffHard" name="difficulty" type="radio" value="hard"/>
<label class="difficulty-option" for="diffHard">‡∏¢‡∏≤‡∏Å (Hard)</label>
<input id="diffHarder" name="difficulty" type="radio" value="harder"/>
<label class="difficulty-option" for="diffHarder">‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô (Harder)</label>
</div>
</div>
<button id="startTestBtn" style="background-color: #28a745;
color: white;">
               ‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            </button>
<hr/>
</div>
<div id="testSection" style="display: none;">
<h2 id="section1Title">üó£Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß/‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢ (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà <span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span>)</h2>
<audio id="customerAudio" src=""></audio>
<button id="recordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</button>
<button disabled="" id="nextRoundBtn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2)</button>
<p id="status">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß</p>
<hr/>
<h2>‚ùì ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="qRound">1</span>/<span id="maxQSpan">10</span>)</h2>
<audio id="questionAudio"></audio>
<button disabled="" id="startQBtn">üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
<button disabled="" id="answerBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
<button disabled="" id="nextSection3Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3)</button>
<p id="qStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2</p>
<hr/>
<h2>üí∞ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ + ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="cRound">1</span>/<span id="maxCSpan">5</span>)</h2>
<button disabled="" id="closeBtn">üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
<audio id="objectionAudio"></audio>
<button disabled="" id="replyBtn">üéôÔ∏è 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
<button disabled="" id="nextSection4Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4)</button>
<p id="cStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 
3</p>
<hr/>
<h2>üè• ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (<span id="hQName">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1/5</span>)</h2>
<audio id="healthAudio"></audio>
<button disabled="" id="startHBtn" style="display:none;">üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
<button disabled="" id="answerHBtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
<button disabled="" id="nextSection5Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5)</button>
<p id="hStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4</p>
<hr/>
<h2>ü§ù ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà <span id="aRound">1</span>/<span id="maxASpan">7</span>)</h2>
<audio id="agreementAudio"></audio>
<button disabled="" id="startABtn">üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
<button disabled="" id="answerABtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</button>
<button disabled="" id="finalSaveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
<p id="aStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5</p>
<hr/>
<div id="certificate">
<h1>‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£</h1>
<p>‡∏Ç‡∏≠‡∏°‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πà</p>
<h2 id="traineeName">[‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô]</h2>
<p>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
<p><strong>‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</strong></p>
<p style="margin-top: 40px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠....................................................</p>
<p>(‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°)</p>
<p style="margin-top: 20px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®: <span id="issueDate"></span></p>
</div>
<button id="certBtn">üéì ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
</div>
</div>
<script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';
        
        // --- 1. Supabase Config & Global State ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        window.supabase = createClient(supabaseUrl, supabaseKey);

        // State Variables
        let masterAudioChunks = [];
        let mediaRecorder = null;
        let mediaStream = null; // *** CRITICAL: ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö Stream ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô ***
        let currentUserId = null; 
        const USER_ID_KEY = 'roleplay_user_id';
        // Round Counters (Dynamic based on difficulty)
        let turn = 0;
        let qRound = 0;
        let cRound = 0;
        let currentHIndex = 0; 
        let isFollowUpMode = false;
        let followUpStep = 0;
        let selectedDisease = null;
        let aRound = 0; 

        // Global Max Rounds (Set dynamically by difficulty)
        let maxTurns;
        let maxQ;
        let maxC;
        const maxH = 5; // Fixed 5 standard health questions
        const maxF = 5; // NEW: Fixed 5 follow-up questions
        let maxA;
        // Difficulty Configurations 
        const difficultyConfig = {
            easy: { S1: 3, S2: 5, S3: 3, S4: 5, S5: 2, label: "‡∏á‡πà‡∏≤‡∏¢ (Easy)" },
            hard: { S1: 5, S2: 8, S3: 5, S4: 5, S5: 3, label: "‡∏¢‡∏≤‡∏Å (Hard)" },
            harder: { S1: 5, S2: 10, S3: 5, S4: 5, S5: 3, label: "‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô (Harder)" }
        };

        // --- 2. Audio Files URL (‡∏ô‡∏≥ URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ---
        // S1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß/‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢
        const allCustomerReplies = [
            "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q1_fe75e00d-70f8-429a-a3ca-9e9b87a5f2de.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q2_a68fb010-ec6c-47c2-95b2-d839553fe4e7.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q3_d974acce-1bc1-4473-a9f6-d49a256636ab.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q4_c3dd3875-fac4-4ad0-96d7-31adf9175c69.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q5_60ca36aa-3425-4824-987a-ff6b7fd7dbe1.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q7_490b0134-6446-4708-b86c-785d31306d07.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q8_ad281257-c3b9-44dd-8ca5-0f383d438003.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q9_36918038-0a42-4b6b-afc6-048a619f589d.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q10_68208219-7f94-48be-8446-d296d03711a3.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q6_75f89f58-d31d-4edb-a47d-901d0dfc92d4.webm"
        ];
        // S2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        const questionFiles = [
            "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-995a-04ea50effbea/part2/q1_426c99f9-e6cc-45d9-995a-04ea50effbea.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-995a-04ea50effbea/part2/q2_512d6ed6-44bd-446b-a12b-8d664dfa6b68.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-995a-04ea50effbea/part2/q3_2ba969e1-7421-41b9-823b-b6115eaf4711.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-995a-04ea50effbea/part2/q4_52a4b384-ccd6-4e6c-86ef-e2b33f9a7c7e.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-995a-04ea50effbea/part2/q5_36097a2d-20e3-4fef-bcf9-807076a90e3b.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-995a-04ea50effbea/part2/q6_3dee5223-9b49-4976-93fa-7b0ed28b111e.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-995a-04ea50effbea/part2/q7_e3bd2454-ca23-4519-bc65-503a28d5b27a.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-995a-04ea50effbea/part2/q8_681b20de-322f-4fc6-8b50-ecd37e265ea6.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-995a-04ea50effbea/part2/q9_a270c910-9a77-42a0-a2cc-7eaab6044f08.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-995a-04ea50effbea/part2/q10_ed542cc5-bf90-4326-b296-21b88ef6334d.webm"
        ];
        // S3: ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á
        const objectionFiles = [
            "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part3/q1_cc419767-be8d-4131-a96c-9ebd05e17c0f.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part3/q2_6c651abe-e8ce-4cc9-9393-4e8e3c0ab007.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part3/q3_6eb4b44a-a1cb-42ff-a48e-12ecd0105b16.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part3/q4_f6cfdb31-8c1a-4a10-9eaa-31adeff615bb.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part3/q5_b126f965-079b-4f50-8818-4ea124cded47.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part3/q6_6e6df3ec-2a70-44b9-ba6d-0f28f650c51.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part3/q7_1bd79b02-b363-4004-80f4-fcc2936fe8ec.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part3/q8_0cca5181-e7e9-4635-914b-050430144c8c.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part3/q9_36918038-0a42-4b6b-afc6-048a619f589d.webm", "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part3/q10_fbba463f-b3a5-4671-a018-006d457ccd6b.webm"
        ];
        // S5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏)
        const REGISTRATION_STEPS = 7;
        const registrationScriptFiles = [
            "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q2/health6_P1_P1Q2_1762518493530.webm", // 1. ‡∏™‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠
            "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q2/health6_P2_P1Q2_1762518493530.webm", // 2. ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏ä‡∏ä
            "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q2/health6_P3_P1Q2_1762518493530.webm", // 3. ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡∏™‡∏°‡∏°‡∏ï‡∏¥ P3 ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
            "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q2/health6_P4_P1Q2_1762518493530.webm", // 4. ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏™‡∏°‡∏°‡∏ï‡∏¥ P4 ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
            "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q2/health6_P5_P1Q2_1762518493530.webm", // 5. ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ (‡∏™‡∏°‡∏°‡∏ï‡∏¥ P5 ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
            "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q2/health6_P6_P1Q2_1762518493530.webm", // 6. PDPA (‡∏™‡∏°‡∏°‡∏ï‡∏¥ P6 ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
            "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q2/health6_P7_P1Q2_1762518493530.webm"  // 7. E-Consent (‡∏™‡∏°‡∏°‡∏ï‡∏¥ P7 ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
        ];
        const registrationStepNames = [
            "1. ‡∏Ç‡∏≠‡∏™‡∏∞‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", "2. ‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô", "3. ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠",
            "4. ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà", "5. ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞", "6. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á PDPA ‡πÅ‡∏•‡∏∞‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢",
            "7. ‡∏≠‡πà‡∏≤‡∏ô E-Consent/E-Legal"
        ];
        // S4: Health Check Data Structure
        const CUSTOMER_NO_URL = "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q3/health5_P1_P1Q3_1762340907852.webm";
        const H_QUESTION_NAMES = ["Q1: ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô", "Q2: ‡∏°‡∏µ‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠", "Q3: ‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö", "Q4: ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥", "Q5: ‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≥‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°"];
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° F4, F5 ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
        const F_QUESTION_NAMES = { 
            1: "F1: ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà", 
            2: "F2: ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£", 
            3: "F3: ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå",
            4: "F4: ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà", 
            5: "F5: ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£" 
        };
        const healthCheckQuestions = [
            // 1. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Q1 ‡∏Ç‡∏≠‡∏á Agent Standard Q)
            { 
                name: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á", 
                standardQIndex: 0, 
                yesTriggerUrl: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q1_9f79f14f-6b49-4215-a8d2-6c290175845c.webm", 
                followUp: { // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏° URL ‡πÅ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 5 ‡∏Ç‡πâ‡∏≠
                    1: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q2_5b21f4b1-a1f1-4f87-823c-32bcee3a1e35.webm", 
                    2: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q3_5b21f4b1-a1f1-4f87-823c-32bcee3a1e35.webm", 
                    3: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-e9b87a5f2de/part3/q3_729a7b65-0e57-4fda-a279-489316b25bda.webm", 
                    4: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-e9b87a5f2de/part3/q3_729a7b65-0e57-4fda-a279-489316b25bda.webm", 
                    5: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-e9b87a5f2de/part3/q3_729a7b65-0e57-4fda-a279-489316b25bda.webm" 
                }
            },
            // 2. ‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Q2 ‡∏Ç‡∏≠‡∏á Agent Standard Q)
            { 
                name: "‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô", 
                standardQIndex: 1, 
                yesTriggerUrl: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q7_536f3217-6342-4545-a163-75914742ee02.webm", 
                followUp: { // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏° URL ‡πÅ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 5 ‡∏Ç‡πâ‡∏≠
                    1: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q8_350a1b41-b1e4-4a62-9483-1c0699e4b118.webm", 
                    2: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q9_394a4cdb-ad91-4765-b403-84c07c9f9479.webm", 
                    3: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q10_bfe52173-ae18-4319-8cf0-92569c1b6037.webm", 
                    4: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-e9b87a5f2de/part3/q3_729a7b65-0e57-4fda-a279-489316b25bda.webm", 
                    5: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-e9b87a5f2de/part3/q3_729a7b65-0e57-4fda-a279-489316b25bda.webm"
                }
            }
        ];

        // --- 3. Utility Functions ---
        function shuffle(array) { 
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // *** Audio Player Utility Function (NEW: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Handler ‡πÄ‡∏™‡∏°‡∏≠) ***
        function playAudio(audioElement, url, loadingMessage, playingMessage, onEndedCallback) {
            audioElement.src = url; 
            audioElement.load();
            audioElement.pause(); // Reset any ongoing playback
            
            // Clear previous handlers to prevent overlapping logic
            audioElement.onloadeddata = null;
            audioElement.onended = null;
            
            // Set loading state
            const statusElement = (audioElement === window.customerAudio) ? window.s1Status : 
                                  (audioElement === window.questionAudio) ? window.qStatus : 
                                  (audioElement === window.objectionAudio) ? window.cStatus : 
                                  (audioElement === window.healthAudio) ? window.hStatus : 
                                  (audioElement === window.agreementAudio) ? window.aStatus : null;
            
            if (statusElement) statusElement.textContent = `‚è≥ ${loadingMessage}`;
            
            audioElement.onloadeddata = () => { 
                if (statusElement) statusElement.textContent = `üîä ${playingMessage}`;
                audioElement.play().catch(error => { 
                    if (statusElement) statusElement.textContent = `‚ùå ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å: ${error.message}.`; 
                    setTimeout(onEndedCallback, 1000); 
                }); 
            };
            
            audioElement.onended = () => {
                // Clear handlers after finishing
                audioElement.onloadeddata = null;
                audioElement.onended = null;
                onEndedCallback();
            };
        }


        // --- 4. Recording Logic (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î) ---
        
        function getSectionStatusElement(type) {
            if (type === 1) return window.s1Status; 
            if (type === 2) return window.qStatus; 
            if (type === 3 || type === 4) return window.cStatus;
            if (type === 5) return window.hStatus; 
            if (type === 6) return window.aStatus; 
            return null;
        }

        function getButtonElement(type) {
            if (type === 1) return window.recordBtn; 
            if (type === 2) return window.answerBtn;
            if (type === 3) return window.closeBtn; 
            if (type === 4) return window.replyBtn; 
            if (type === 5) return window.answerHBtn;
            if (type === 6) return window.answerABtn; 
            return null;
        }

        /**
         * @param {number} type - 1: S1, 2: S2, 3: S3-Close, 4: S3-Reply, 5: S4, 6: S5
         */
        window.toggleRecording = async function(type) {
            const buttonElement = getButtonElement(type);
            const statusElement = getSectionStatusElement(type);
            const originalButtonText = buttonElement.textContent; // Store original text

            if (buttonElement.disabled && mediaRecorder === null) return; 

            if (!mediaRecorder) { 
                // --- START RECORDING ---
                try { 
                    // ‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true }); 
                    mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'audio/webm' }); 
                    let localChunks = []; 
                    
                    mediaRecorder.ondataavailable = event => { 
                        if (event.data.size > 0) {
                            localChunks.push(event.data); 
                        }
                    };

                    // *** CRITICAL FIX: onstop Handler ‡πÅ‡∏•‡∏∞ Cleaner Logic ***
                    mediaRecorder.onstop = () => {
                        
                        // 1. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ
                        if (localChunks.length > 0) {
                            const audioBlob = new Blob(localChunks, { type: 'audio/webm' });
                            masterAudioChunks.push(audioBlob);
                            statusElement.textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!`;
                        } else {
                            statusElement.textContent = `‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!`;
                        }

                        // 2. ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Stream ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å)
                        if (mediaStream) {
                            mediaStream.getTracks().forEach(track => track.stop()); 
                        }
                        
                        // 3. ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Recorders/Streams ‡πÅ‡∏•‡∏∞ UI
                        mediaRecorder = null; 
                        mediaStream = null; 
                        
                        // Restore button text to original and re-enable it (handleRecordingStop handles the next state)
                        if (type === 1) buttonElement.textContent = 'üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)';
                        else if (type === 2) buttonElement.textContent = 'üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö';
                        else if (type === 3) buttonElement.textContent = 'üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢';
                        else if (type === 4) buttonElement.textContent = 'üéôÔ∏è 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á';
                        else if (type === 5) buttonElement.textContent = 'üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û';
                        else if (type === 6) buttonElement.textContent = 'üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö';

                        // 4. Logic ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        window.handleRecordingStop(type, statusElement);
                    };
                    
                    mediaRecorder.start();

                    // Change button state and UI for recording
                    buttonElement.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"; 
                    if (type === 1) buttonElement.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö";
                    else if (type === 2) buttonElement.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö";
                    else if (type === 3) buttonElement.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢";
                    else if (type === 4) buttonElement.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á";
                    else if (type === 5 || type === 6) buttonElement.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö";
                    
                    statusElement.textContent = "üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                    buttonElement.disabled = false; 
                    
                    // Disable section end buttons while recording
                    if (type === 1) window.nextRoundBtn.disabled = true; 
                    if (type === 2) window.nextSection3Btn.disabled = true; 
                    if (type === 5) window.nextSection5Btn.disabled = true; 
                    if (type === 6) window.finalSaveBtn.disabled = true; 

                } catch (err) { 
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
                    if (mediaStream) mediaStream.getTracks().forEach(track => track.stop()); 
                    mediaRecorder = null;
                    mediaStream = null;
                    buttonElement.textContent = originalButtonText;
                    buttonElement.disabled = false;
                    statusElement.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô: ${err.name}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå.`;
                    console.error('Microphone Error:', err);
                } 
            } else { 
                // --- STOP RECORDING ---
                buttonElement.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                buttonElement.disabled = true;
                // mediaRecorder.onstop ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                if (mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop(); 
                }
            }
        } 
        
        // *** NEW: Centralized Stop Handler Logic ***
        window.handleRecordingStop = function(type, statusElement) {
            
            // Auto-advance logic after stopping recording
            if (type === 1) { 
                if (turn < maxTurns) { 
                    window.endTurn(); // Play next customer reply
                } else { 
                    window.nextRoundBtn.disabled = false;
                    statusElement.textContent = `üéâ ‡∏à‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1! ‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1'`;
                    window.recordBtn.disabled = true; 
                }
            } else if (type === 2) { 
                qRound++;
                if (qRound < maxQ) {
                    window.startQBtn.disabled = false;
                    statusElement.textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${qRound}/${maxQ} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`;
                    window.answerBtn.disabled = true;
                } else {
                    window.nextSection3Btn.disabled = false;
                    statusElement.textContent = `üéâ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°-‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö ${maxQ} ‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2'`;
                    window.answerBtn.disabled = true;
                }
            } else if (type === 3) { 
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß -> ‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á
                window.replyBtn.disabled = false;
                window.closeBtn.disabled = true;
                window.playRandomObjection();
            } else if (type === 4) { 
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß -> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
                window.closeBtn.style.display = 'block'; 
                window.replyBtn.disabled = true;
                cRound++; // ‡∏ô‡∏±‡∏ö‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à (1 ‡∏£‡∏≠‡∏ö = close + reply)

                if (cRound >= maxC) {
                    window.cStatus.textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4";
                    window.closeBtn.disabled = true;
                    window.nextSection4Btn.disabled = false;
                } else {
                     window.cStatus.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${cRound + 1}/${maxC}`;
                     window.closeBtn.disabled = false;
                }

            } else if (type === 5) { 
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û/‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß -> ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                window.playDynamicHealthQuestion(); 
                window.answerHBtn.disabled = true;
            } else if (type === 6) { 
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß -> ‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                window.advanceRegistrationStep(); 
            }
        }
        
        // --- 5. Section 1 Functions --- 
        let selectedRandomFiles = [];
        const fixedFirstObjection = "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q1_fe75e00d-70f8-429a-a3ca-9e9b87a5f2de.webm"; 
        const finalObjection = "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q6_75f89f58-d31d-4edb-a47d-901d0dfc92d4.webm"; 

        function prepareTurnFiles() { 
            selectedRandomFiles = [fixedFirstObjection];
            shuffle(allCustomerReplies); 
            const randomCount = Math.min(maxTurns - 2, allCustomerReplies.length);
            const threeRandom = allCustomerReplies.slice(0, randomCount);
            selectedRandomFiles.push(...threeRandom);
            if (maxTurns > 1) { // Ensure final objection is added only if more than 1 turn
                selectedRandomFiles.push(finalObjection); 
            }
        }

        window.endTurn = function() { 
            if (turn < maxTurns) { 
                turn++;
                window.turnSpan.textContent = turn;
                const fileToPlay = selectedRandomFiles[turn - 1];
                
                playAudio(
                    window.customerAudio, 
                    fileToPlay, 
                    `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...`, 
                    `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà ${turn}/${maxTurns})...`, 
                    () => { // onEndedCallback
                        if (turn < maxTurns) { 
                            window.s1Status.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà ${turn + 1}/${maxTurns})`; 
                            window.recordBtn.disabled = false;
                        } else {
                            window.nextRoundBtn.disabled = false;
                            window.s1Status.textContent = `üéâ ‡∏à‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1! ‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1'`;
                            window.recordBtn.disabled = true;
                        }
                    }
                );
            }
        } 
        
        window.initSection2 = function() {
            window.nextRoundBtn.disabled = true;
            window.recordBtn.disabled = true;
            
            window.startQBtn.disabled = false;
            window.answerBtn.disabled = true;
            window.nextSection3Btn.disabled = true;
            
            qRound = 0;
            questionPool = [...questionFiles]; 
            window.maxQSpan.textContent = maxQ;
            
            window.qStatus.textContent = "‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2";
            alert("‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 ‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤");
            window.startQBtn.textContent = `üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 1/${maxQ}`;
        }
        
        // --- 6. Section 2 Functions ---
        let questionPool = []; 
        
        window.playRandomQuestion = function() {
            qRound++; 
            
            if (qRound > maxQ) {
                window.qStatus.textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3";
                window.startQBtn.disabled = true;
                window.answerBtn.disabled = true;
                window.nextSection3Btn.disabled = false;
                return;
            }
            window.qRound.textContent = qRound;

            const currentPool = questionPool.slice(0, maxQ - qRound + 1);
            if (currentPool.length === 0) return; 
            const randomIndex = Math.floor(Math.random() * currentPool.length);
            const selectedFile = currentPool[randomIndex];
            
            questionPool.splice(questionPool.indexOf(selectedFile), 1);
            
            window.startQBtn.disabled = true;
            window.answerBtn.disabled = true;
            
            playAudio(
                window.questionAudio, 
                selectedFile, 
                `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...`, 
                `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${qRound}/${maxQ}...`, 
                () => { // onEndedCallback
                    window.qStatus.textContent = "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö";
                    window.answerBtn.disabled = false;
                    
                    if (qRound === 1) window.startQBtn.style.display = 'none'; 

                    if (qRound < maxQ) {
                        window.startQBtn.textContent = `üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${qRound + 1}/${maxQ}`;
                    }
                }
            );
        }
        
        window.initSection3 = function() {
            window.nextSection3Btn.disabled = true;
            window.startQBtn.disabled = true;
            window.answerBtn.disabled = true;
            
            window.closeBtn.disabled = false; 
            window.replyBtn.disabled = true;
            window.nextSection4Btn.disabled = true;
            
            cRound = 0;
            objectionPool = [...objectionFiles]; 
            window.maxCSpan.textContent = maxC;

            window.closeBtn.style.display = 'block';
            window.cStatus.textContent = "‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏î '1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢";
            alert("‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 ‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ + ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á");
        }
        
        // --- 7. Section 3 Functions ---
        let objectionPool = []; 

        window.playRandomObjection = function() {
            if (cRound >= maxC) {
                return;
            }
            
            // Hide Close button while objection plays
            window.closeBtn.style.display = 'none'; 

            const currentPool = objectionPool.slice(0, maxC - cRound);
            if (currentPool.length === 0) return; 
            const randomIndex = Math.floor(Math.random() * currentPool.length);
            const selectedFile = currentPool[randomIndex];
            
            objectionPool.splice(objectionPool.indexOf(selectedFile), 1);
            
            window.replyBtn.disabled = true;

            playAudio(
                window.objectionAudio, 
                selectedFile, 
                `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...`, 
                `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${cRound + 1}/${maxC}...`, 
                () => { // onEndedCallback
                    window.cStatus.textContent = "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á";
                    window.replyBtn.disabled = false; // Enable reply button
                }
            );
        }
        
        window.initSection4 = function() {
            window.nextSection4Btn.disabled = true;
            window.replyBtn.disabled = true;
            window.closeBtn.style.display = 'none'; 
            
            window.answerHBtn.disabled = false; 
            window.nextSection5Btn.disabled = true;
            
            currentHIndex = 0;
            isFollowUpMode = false;
            followUpStep = 0;
            selectedDisease = null;
            
            updateHealthQuestionUI();
            
            window.hStatus.textContent = "‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1/5";
            alert("‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 ‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (5 ‡∏Ç‡πâ‡∏≠)");
        }

        function updateHealthQuestionUI() {
            const questionText = isFollowUpMode 
                ? F_QUESTION_NAMES[followUpStep]
                : H_QUESTION_NAMES[currentHIndex];
            
            const roundText = isFollowUpMode 
                ? `‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: ${F_QUESTION_NAMES[followUpStep]} (‡πÇ‡∏£‡∏Ñ: ${selectedDisease.name})` 
                : `${currentHIndex + 1}/${maxH}`;

            window.section1Title.textContent = `üè• ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (${isFollowUpMode ? '‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥' : '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà'} ${roundText})`;
            window.hQName.textContent = questionText; 
        }

        // --- 8. Section 4 Functions (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 5 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô) ---

        window.playDynamicHealthQuestion = function() {
            window.answerHBtn.disabled = true; 
            
            const handleEndPlayback = () => {
                if (isFollowUpMode) {
                    followUpStep++;
                    if (followUpStep > maxF) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö maxF = 5
                        // ‡∏à‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ
                        isFollowUpMode = false;
                        selectedDisease = null;
                        followUpStep = 0;
                        currentHIndex++; // ‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                        
                        if (currentHIndex < maxH) {
                            updateHealthQuestionUI();
                            window.hStatus.textContent = `‚úÖ ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${currentHIndex + 1}/${maxH}`;
                            window.answerHBtn.disabled = false;
                        } else {
                            window.nextSection5Btn.disabled = false;
                            window.hStatus.textContent = `üéâ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏ö ${maxH} ‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5`;
                        }
                    } else { 
                        // ‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (F2, F3, F4, F5)
                        updateHealthQuestionUI(); 
                        window.hStatus.textContent = `‚úÖ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠ '‡πÉ‡∏ä‡πà' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ ${F_QUESTION_NAMES[followUpStep]}`;
                        window.answerHBtn.disabled = false;
                    } 
                } else {
                    currentHIndex++;
                    if (currentHIndex < maxH) {
                        updateHealthQuestionUI();
                        window.hStatus.textContent = `‚úÖ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠ '‡πÑ‡∏°‡πà' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${currentHIndex + 1}/${maxH}`;
                        window.answerHBtn.disabled = false;
                    } else {
                        window.nextSection5Btn.disabled = false;
                        window.hStatus.textContent = `üéâ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏ö ${maxH} ‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5`;
                    }
                }
            };


            if (isFollowUpMode) {
                // --- A. ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ (F1, F2, F3, F4, F5) ---
                const customerAnswerUrl = selectedDisease.followUp[followUpStep];
                const stepName = F_QUESTION_NAMES[followUpStep];

                playAudio(
                    window.healthAudio, 
                    customerAnswerUrl, 
                    `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ${stepName} (‡πÇ‡∏£‡∏Ñ: ${selectedDisease.name})...`,
                    `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...`,
                    handleEndPlayback
                );

            } else { 
                // --- B. ‡πÇ‡∏´‡∏°‡∏î 5 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Standard 5 Qs) ---
                const triggerDisease = healthCheckQuestions.find(d => d.standardQIndex === currentHIndex);
                
                if (triggerDisease) {
                    // Simulate customer saying 'Yes'
                    selectedDisease = triggerDisease;
                    isFollowUpMode = true;
                    followUpStep = 1; // Start follow-up questions (F1)

                    playAudio(
                        window.healthAudio, 
                        selectedDisease.yesTriggerUrl, 
                        `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö"...`,
                        `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö"...`,
                        () => { // onEndedCallback for Yes-Trigger
                            updateHealthQuestionUI(); // Update UI for F1
                            window.hStatus.textContent = `‚úÖ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠ '‡πÉ‡∏ä‡πà' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ ${F_QUESTION_NAMES[followUpStep]}`;
                            window.answerHBtn.disabled = false;
                        }
                    );
                } else {
                    // Simulate customer saying 'No'
                    playAudio(
                        window.healthAudio, 
                        CUSTOMER_NO_URL, 
                        `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö"...`,
                        `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö"...`,
                        handleEndPlayback // Move to next standard question
                    );
                }
            } 
        }

        // --- 9. Section 5 Functions ---
        window.initSection5 = function() {
            window.nextSection5Btn.disabled = true;
            window.startHBtn.disabled = true;
            window.answerHBtn.disabled = true;
            
            window.startABtn.disabled = false;
            window.answerABtn.disabled = true;
            window.finalSaveBtn.disabled = true;
            
            maxA = REGISTRATION_STEPS; // Set max steps for S5 (7 steps)
            window.maxASpan.textContent = maxA;
            aRound = 0; 
            
            window.aStatus.textContent = "‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5 (7 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)";
            alert("‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4 ‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (7 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)");
            window.startABtn.textContent = `üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô 1/${maxA}`;
        }
        
        window.playSequentialRegistrationPrompt = function() {
            if (aRound >= maxA) {
                window.aStatus.textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î'";
                window.startABtn.disabled = true;
                window.answerABtn.disabled = true;
                window.finalSaveBtn.disabled = false;
                return;
            }
            
            aRound++;
            window.aRoundSpan.textContent = aRound;
            
            const fileToPlay = registrationScriptFiles[aRound - 1];
            const stepName = registrationStepNames[aRound - 1];
            
            window.startABtn.disabled = true;
            window.answerABtn.disabled = true;

            playAudio(
                window.agreementAudio, 
                fileToPlay, 
                `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô: ${stepName}...`, 
                `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${aRound}/${maxA}: ${stepName}...`, 
                () => { // onEndedCallback
                    window.aStatus.textContent = "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô";
                    window.answerABtn.disabled = false;
                    
                    if (aRound < maxA) {
                        window.startABtn.textContent = `üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ${aRound + 1}/${maxA}`;
                    }
                }
            );
        }
        
        window.advanceRegistrationStep = function() {
            window.answerABtn.disabled = true;
            if (aRound < maxA) {
                window.startABtn.disabled = false;
                window.aStatus.textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${aRound}/${maxA} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`;
            } else {
                window.playSequentialRegistrationPrompt(); // Will trigger the final save prompt (if aRound = maxA)
            }
        }
        
        // --- 10. Supabase & Upload Functions ---
        window.uploadFinalRecording = async function(audioBlob) {
            window.loadingOverlay.style.display = 'flex';
            window.loadingText.textContent = "1/3: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡∏ß‡∏°...";
            window.uploadProgressBar.style.width = "30%";

            const storagePath = `recordings/${currentUserId}/${uuidv4()}.webm`;

            const { data, error: uploadError } = await window.supabase.storage
                .from('responses')
                .upload(storagePath, audioBlob, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (uploadError) {
                window.loadingOverlay.style.display = 'none';
                console.error('Supabase Storage upload error:', uploadError);
                return false;
            }

            // 2. Insert metadata into database
            window.loadingText.textContent = "2/3: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö...";
            window.uploadProgressBar.style.width = "70%";

            const filePath = data.path; 

            const userName = window.inputUserName.value.trim() || `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ID: ${currentUserId}`;
            const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
            const difficultyLabel = difficultyConfig[selectedDifficulty].label;

            const { error: dbError } = await window.supabase
                .from('recordings')
                .insert([
                    { 
                        user_id: currentUserId, 
                        user_name: userName, 
                        file_path: filePath, 
                        difficulty: difficultyLabel,
                        section_1_turns: maxTurns,
                        section_2_qs: maxQ,
                        section_3_objections: maxC,
                        section_4_health_qs: maxH,
                        section_5_agreement_steps: maxA 
                    },
                ]);

            window.loadingOverlay.style.display = 'none';

            if (dbError) {
                console.error('Supabase DB insert error:', dbError);
                alert(`‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ${dbError.message}`);
            }

            window.loadingText.textContent = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!";
            window.uploadProgressBar.style.width = "100%";
            return true;
        }

        window.saveAllRecordings = function() {
            if (masterAudioChunks.length === 0) {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ! ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' ‡πÅ‡∏•‡∏∞ '‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
                return;
            }
            if (!window.inputUserName.value.trim()) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
                window.inputUserName.focus();
                return;
            }

            window.finalSaveBtn.disabled = true;
            window.finalSaveBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...";

            const audioBlob = new Blob(masterAudioChunks, { type: 'audio/webm' });

            window.uploadFinalRecording(audioBlob).then(success => {
                if (success) {
                    window.finalSaveBtn.textContent = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡∏ß‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!";
                    window.finalSaveBtn.classList.add('done');
                    window.generateCertificate();
                } else {
                    window.finalSaveBtn.disabled = false;
                    window.finalSaveBtn.textContent = "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                }
            }).catch(err => {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î:', err);
                alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: ${err.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Internet/RLS.`);
                window.finalSaveBtn.disabled = false;
                window.finalSaveBtn.textContent = "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
            });
        }
        
        // --- 11. Certificate Logic ---
        window.generateCertificate = function() {
            window.traineeName.textContent = window.inputUserName.value.trim();
            window.issueDate.textContent = new Date().toLocaleDateString('th-TH', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });
            window.certificate.style.display = 'block';
            window.certBtn.textContent = "‚úÖ ‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô";
            window.certBtn.disabled = true;
            
            window.certificate.scrollIntoView({ behavior: 'smooth' });
        }

        // --- 12. Initialization & Event Listeners ---
        function initializeUserAndElements() {
            currentUserId = localStorage.getItem(USER_ID_KEY);
            if (!currentUserId) {
                currentUserId = uuidv4();
                localStorage.setItem(USER_ID_KEY, currentUserId);
            }

            // Get DOM elements
            window.registrationSection = document.getElementById('registrationSection');
            window.testSection = document.getElementById('testSection');
            window.inputUserName = document.getElementById('inputUserName');
            window.startTestBtn = document.getElementById('startTestBtn');
            window.loadingOverlay = document.getElementById('loadingOverlay');
            window.loadingText = document.getElementById('loadingText');
            window.uploadProgressBar = document.getElementById('uploadProgressBar');
            window.certificate = document.getElementById('certificate');
            window.traineeName = document.getElementById('traineeName');
            window.issueDate = document.getElementById('issueDate');
            window.certBtn = document.getElementById('certBtn');
            window.section1Title = document.getElementById('section1Title'); 

            // S1
            window.turnSpan = document.getElementById('turnSpan');
            window.maxTurnSpan = document.getElementById('maxTurnSpan');
            window.customerAudio = document.getElementById('customerAudio');
            window.recordBtn = document.getElementById('recordBtn');
            window.nextRoundBtn = document.getElementById('nextRoundBtn');
            window.s1Status = document.getElementById('status'); 

            // S2
            window.qRound = document.getElementById('qRound');
            window.maxQSpan = document.getElementById('maxQSpan');
            window.questionAudio = document.getElementById('questionAudio');
            window.startQBtn = document.getElementById('startQBtn');
            window.answerBtn = document.getElementById('answerBtn');
            window.nextSection3Btn = document.getElementById('nextSection3Btn');
            window.qStatus = document.getElementById('qStatus');

            // S3
            window.cRoundSpan = document.getElementById('cRound');
            window.maxCSpan = document.getElementById('maxCSpan');
            window.closeBtn = document.getElementById('closeBtn');
            window.objectionAudio = document.getElementById('objectionAudio');
            window.replyBtn = document.getElementById('replyBtn');
            window.nextSection4Btn = document.getElementById('nextSection4Btn');
            window.cStatus = document.getElementById('cStatus');

            // S4
            window.hQName = document.getElementById('hQName');
            window.healthAudio = document.getElementById('healthAudio');
            window.startHBtn = document.getElementById('startHBtn'); 
            window.answerHBtn = document.getElementById('answerHBtn');
            window.nextSection5Btn = document.getElementById('nextSection5Btn');
            window.hStatus = document.getElementById('hStatus');

            // S5
            window.aRoundSpan = document.getElementById('aRound');
            window.maxASpan = document.getElementById('maxASpan');
            window.agreementAudio = document.getElementById('agreementAudio');
            window.startABtn = document.getElementById('startABtn');
            window.answerABtn = document.getElementById('answerABtn');
            window.finalSaveBtn = document.getElementById('finalSaveBtn');
            window.aStatus = document.getElementById('aStatus');

            setupEventListeners();
        }

        function setupEventListeners() {
            window.startTestBtn.addEventListener('click', window.startTest);

            // S1
            window.recordBtn.addEventListener('click', () => window.toggleRecording(1));
            window.nextRoundBtn.addEventListener('click', window.initSection2);

            // S2
            window.startQBtn.addEventListener('click', window.playRandomQuestion);
            window.answerBtn.addEventListener('click', () => window.toggleRecording(2));
            window.nextSection3Btn.addEventListener('click', window.initSection3);

            // S3
            window.closeBtn.addEventListener('click', () => window.toggleRecording(3));
            window.replyBtn.addEventListener('click', () => window.toggleRecording(4));
            window.nextSection4Btn.addEventListener('click', window.initSection4);

            // S4
            window.answerHBtn.addEventListener('click', () => window.toggleRecording(5));
            window.nextSection5Btn.addEventListener('click', window.initSection5);
            
            // S5
            window.startABtn.addEventListener('click', window.playSequentialRegistrationPrompt);
            window.answerABtn.addEventListener('click', () => window.toggleRecording(6));
            window.finalSaveBtn.addEventListener('click', window.saveAllRecordings);
            
            window.certBtn.addEventListener('click', window.generateCertificate);
        }

        window.startTest = function() {
            const userName = window.inputUserName.value.trim();
            if (!userName) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
                window.inputUserName.focus();
                return;
            }
            
            const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
            const config = difficultyConfig[selectedDifficulty];

            // 1. Set Global Max Rounds 
            maxTurns = config.S1;
            maxQ = config.S2;
            maxC = config.S3;
            maxA = REGISTRATION_STEPS; // Fixed 7 steps regardless of difficulty

            // 2. Update UI Spans with Max Rounds
            window.maxTurnSpan.textContent = maxTurns;
            window.maxQSpan.textContent = maxQ;
            window.maxCSpan.textContent = maxC;
            window.maxASpan.textContent = maxA; 

            // 3. Hide Registration and Show Test Section
            window.registrationSection.style.display = 'none';
            window.testSection.style.display = 'block';

            // 4. Initialize Test Flow
            prepareTurnFiles(); 
            window.recordBtn.disabled = false;
            window.s1Status.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà 1/${maxTurns})`;
        }

        document.addEventListener('DOMContentLoaded', initializeUserAndElements);
    </script>
</body>
</html>
